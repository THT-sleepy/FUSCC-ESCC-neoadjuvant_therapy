# 髓系细胞注释过程及结果记录         (What)

* Nov 17, 2025                                 (When)
* liyi /data1/liyi/zhaoyue/FUSCC-ESCC-neoadjuvant_thrapy           (Where)
* 单细胞需要注释后才能进行后续分析 (Why)


## 先看看聚类情况和celltypist的结果
<img src="..\figures\umapMyeloid cell_umapmd0.4_regressmtribo_cluster.png">
<img src="..\figures\umap1117_celltypist_coarse_Myeloid.png">
<img src="..\figures\umap1117_celltypist_fine_Myeloid.png">


## 1 再次检查有无混杂的其它细胞系如上皮的marker表达


```
import scanpy as sc
sc.settings.set_figure_params(
    dpi=300,
    facecolor="white",
    frameon=False
)
sc.settings.figdir = "plots"

adata = sc.read("RData/Myeloid cell__umapmd0.4.h5ad")
marker_genes = ["PTPRC","CD3E","CD79A","COL1A1",
"VWF","PECAM1","EPCAM","SFN","KRT5","LYZ","GCA","TPSAB1"]
sc.pl.umap(adata,color=marker_genes,vmin=0,vmax="p99",sort_order=False,cmap="Blues",save="121_Myeloid_majormarker.png")

```
<img src="..\figures\umap121_Myeloid_majormarker.png">
res0.8的第10群是混了T细胞，肥大里面混了一点上皮，不过也去不掉

## 筛marker
```

marker_genes = {
"Macro": ["CD14", "FCGR3A", "FCGR3B", "CD68", "INHBA", "IL1RN", "CCL4", "NLRP3", "EREG", "IL1B","LYVE1", "PLTP", "SEPP1", "C1QC", "C1QA", "APOE"],
"Mono CD16+": ["FCGR3A", "FCGR3B", "LST1", "LILRB2"],
"Mono CD14+": ["CD14", "FCN1", "S100A8", "S100A9"],
"Mast": ["TPSB2", "CPA3", "KIT", "TPSAB1", "CPA3"],
"cDC1": ["CLEC9A", "FLT3", "IDO1", "RAB7B", "CLNK", "BATF3", "CADM1", "FKBP1B", "DBN1", "XCR1"],
"cDC2": ["CD1C", "CD1E", "FCER1A", "HLA-DQA1", "CD1A", "PLEK2", "CD207", "FCGBP", "CLDN1", "PPM1N", "IL22RA2", "NRN1", "LYZ", "SERPINA1", "CLEC10A", "STX11", "CST1A", "CFP", "CEBPD", "CD81","CD9","IL1B", "TMEM176B", "SPP1", "CD24"],
"cDC3": ["LAMP3", "CCR7", "FSCN1"],
"pDC": ["CLEC4C", "LIRA4", "GZMB", "IL3RA", "ITM2C", "JCHAIN", "MZB1", "SCT1"],
"Neutrophil": ["CSF3R", "FCGR3B", "CXCR2"],
}
marker_genes_in_data = {}
for ct, markers in marker_genes.items():
    markers_found = []
    for marker in markers:
        if marker in adata.var.index:
            markers_found.append(marker)
    marker_genes_in_data[ct] = markers_found
sc.pl.umap(adata,color=marker_genes_in_data["Macro"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_Macromarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["Mono CD16+"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_Mono_CD16markers.png")
sc.pl.umap(adata,color=marker_genes_in_data["Mono CD14+"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_Mono_CD14markers.png")
sc.pl.umap(adata,color=marker_genes_in_data["Mast"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_Mastmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["cDC1"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_cdc1markers.png")
sc.pl.umap(adata,color=marker_genes_in_data["cDC2"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_cdc2markers.png")
sc.pl.umap(adata,color=marker_genes_in_data["cDC3"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_cdc3markers.png")
sc.pl.umap(adata,color=marker_genes_in_data["pDC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_pDCmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["Neutrophil"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid_Neutrophilmarkers.png")
```
<img src="..\figures\umapMyeloid cell_umapmd0.4_regressmtribo_cluster.png">
res0.8的0，1，2，3应该是CD14+Mono,几个marker都还不错
<img src="..\figures\umap121Myeloid_Mono_CD14markers.png">
res0.8的第8群应该是CD16+Mono，几个marker都还不错
<img src="..\figures\umap121Myeloid_Mono_CD16markers.png"><br>
CCL4,IL1B,C1QC,C1QA,APOE可以分出res0.8的4和7群
<img src="..\figures\umap121Myeloid_Macromarkers.png">
FLT3,IDO1,CADM1,是第11群
<img src="..\figures\umap121Myeloid_cdc1markers.png">
CLEC10A,CD1C,CD1E,FCER1A,应该是第res0.8的第6群
<img src="..\figures\umap121Myeloid_cdc2markers.png">
CLEC4C,GZMB,ITM2C,JCHAIN,MZB1,是res0.8的第9群
<img src="..\figures\umap121Myeloid_pDCmarkers.png">
cDC3也是第11群
<img src="..\figures\umap121Myeloid_cdc3markers.png">

。。
<img src="..\figures\umap121Myeloid_Neutrophilmarkers.png">

把第10群去掉，可以直接用经典marker画个点图看一下
```
adata = adata[adata.obs.leiden_res0_8 != '10'].copy()
marker_genes = {
"Mono CD14+": ["CD14", "FCN1", "S100A8", "S100A9"],
"Mono CD16+": ["FCGR3A", "FCGR3B", "LST1", "LILRB2"],
"Macro": ["C1QC", "C1QA", "APOE","PLTP","IL1B","CCL4"],
"Mast": ["TPSB2", "CPA3", "KIT", "TPSAB1", "CPA3"],
"cDC1": ["CLEC9A", "FLT3", "IDO1", "CADM1",],
"cDC2": ["CD1C", "CD1E", "FCER1A","CLEC10A",],
"cDC3": ["LAMP3", "CCR7", "FSCN1"],
"pDC": ["CLEC4C", "GZMB","ITM2C", "JCHAIN", "MZB1"],
}
sc.pl.dotplot(
    adata,
    groupby="leiden_res0_8",
    categories_order = ["0",
                        "1",
                        "2",
                        "3",
                        "8",
                        "4",
                        "7",
                        "5",
                        "11",
                        "6",
                        "11",
                        "9",],
    var_names=marker_genes,
    standard_scale="var",
    save="Myeloid_亚类marker.png"
)
```
<img src="..\figures\dotplot_Myeloid_亚类marker.png">

再结合DEG挑一下marker
```
sc.tl.rank_genes_groups(
 adata, groupby="leiden_res0_8", method="wilcoxon", key_added="dea_leiden_res0_8"
)
sc.tl.filter_rank_genes_groups(
  adata,
  min_in_group_fraction=0.2,
  max_out_group_fraction=0.2,
  key="dea_leiden_res0_8",
  key_added="dea_leiden_res0_8_filtered",
 )
sc.pl.rank_genes_groups_dotplot(
  adata,
  groupby="leiden_res0_8",
  standard_scale="var",
  n_genes=10,
  key="dea_leiden_res0_8_filtered",
  save="regressmtribo_121_res0_8_Myeloid_top10gene.png"
)
```
<img src="..\figures\dotplot_regressmtribo_121_res0_8_Myeloid_top10gene.png">

```
adata = sc.read("RData/Myeloid cell__umapmd0.4.h5ad")
adata = adata[adata.obs.leiden_res0_8 != '10'].copy()
cl_annotation = {
    "0": "c21_Mono_CD14",
    "1": "c21_Mono_CD14",
    "2": "c21_Mono_CD14",
    "3": "c21_Mono_CD14",
    "4": "c23_Macro_C1QC",
    "5":"c28_Mast_KIT",
    "6": "c25_cDC2_CD1C",
    "7": "c24_Macro_IL1B",
    "8": "c22_Mono_FCGR3A",
    "9": "c27_pDC_CLEC4C",
    "11": "c26_cDC1/cDC3_LAMP3",
}
adata.obs["minor_celltype"]=adata.obs.leiden_res0_8.map(cl_annotation)
adata.write("RData/Myeloid_annotated.h5ad")
```

### umap clt

```
sc.settings.set_figure_params(
    dpi=300,
    facecolor="white",
    frameon=True
)
palette = {
     "c21":"#D8432E",
     "c22":"#F19B9B",
     "c23":"#F4BC82",
     "c24":"#ABE0ED",
     "c25":"#C0FEFC",
     "c26":"#D8C6DF",
     "c27":"#F6C589",
     "c28":"#F2ACAE",
}
cl_annotation = {
    "0": "c21",
    "1": "c21",
    "2": "c21",
    "3": "c21",
    "4": "c23",
    "5":"c28",
    "6": "c25",
    "7": "c24",
    "8": "c22",
    "9": "c27",
    "11": "c26",
}
adata.obs["minor_clt"]=adata.obs.leiden_res0_8.map(cl_annotation)
sc.pl.umap(adata,color="minor_clt",legend_loc="on data",title="Myeloid cells\n(n=141015)",palette=palette,save="Myeloid.png")
```
<img src="..\figures\umapMyeloid.png">


### umap sample_site
```
def determine_sample_site(group_name):
    # 检查 group_name 是否是字符串并且包含 'pbmc'
    if isinstance(group_name, str) and 'pbmc' in group_name.lower():
        return 'blood'
    else:
        return 'tumor'

# 使用 .apply() 将函数应用到 'sample_group' 列的每一个元素
adata.obs['sample_site'] = adata.obs['sample_group'].apply(determine_sample_site)
palette = {
     "blood":"#3A6FA1",
     "tumor":"#BA3931",
}
sc.pl.umap(adata,color="sample_site",palette=palette,save="Myeloid_samplesite.png")
```
<img src="..\figures\umapMyeloid_samplesite.png">

### 检查每个cluster患者数
```
adata.obs['Patient_ID'] = adata.obs['sample'].str.split('_').str[-1]
patient_count_by_celltype = adata.obs.groupby('minor_celltype')['Patient_ID'].nunique()
```
<img src="..\figures\1118_Myeloid亚群患者数.png">

### 点图
```
marker_genes = [
"CD14", "FCN1", "S100A8", "S100A9",
"FCGR3A", "FCGR3B", "LST1", "LILRB2",
"C1QC", "C1QA", "APOE","PLTP",
"IL1B",
"CD1C", "CD1E", "FCER1A","CLEC10A",
"LAMP3", "CCR7", "FSCN1", "FLT3","IDO1",
"CLEC4C", "GZMB","ITM2C", "JCHAIN", "MZB1",
"TPSB2", "CPA3", "KIT", "TPSAB1", "CPA3",
]
from matplotlib.colors import LinearSegmentedColormap
custom_cmap = LinearSegmentedColormap.from_list("custom", ["#0A3D7C", "#F6F6F6", "#810426"])
dp = sc.pl.dotplot(
        adata,
        groupby="minor_celltype",
        categories_order = ["c21_Mono_CD14",
                            "c22_Mono_FCGR3A",
                            "c23_Macro_C1QC",
                            "c24_Macro_IL1B",
                            "c25_cDC2_CD1C",
                            "c26_cDC1/cDC3_LAMP3",
                            "c27_pDC_CLEC4C",
                            "c28_Mast_KIT",],
        var_names=marker_genes,
        standard_scale="var",
        return_fig=True,
        var_group_labels="        ",
        var_group_positions = [(0,3),(4,7),(8,11),
        (12,12),(13,16),(17,21),(22,26),(27,31)],
        cmap = custom_cmap
    )
dp.style(dot_edge_color='black', dot_edge_lw=1).savefig("plots/1118_dotplot_Myeloid.png")
```
<img src="..\figures\1118_dotplot_Myeloid.png">
