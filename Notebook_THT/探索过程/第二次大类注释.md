# 第二次注释过程及结果记录         (What)

* Nov 10, 2025                                 (When)
* liyi /data1/liyi/zhaoyue/FUSCC-ESCC-neoadjuvant_thrapy           (Where)
* 去掉了6个非化免的样本,重新做一下大类注释 (Why)

## 这一步目标是
### 1 分出T&ILC,B,Myeloid,Endo,Fib,Epi
### 2 找到划分大群最佳的markers
### 3 去掉表达多个最佳markers的"可能双细胞"

### 先看看聚类的情况
<img src="..\figures\121umaphvg4000_cluster.png">

### 导入adata,设置好相关绘图参数
```
import scanpy as sc
sc.settings.set_figure_params(
    dpi=300,
    facecolor="white",
    frameon=False
)
sc.settings.figdir = "plots"
adata = sc.read("RData/hvg4000_cluster.h5ad")

```

### 先用PTPRC看一下哪些是Immune和Non-Immune
```
sc.pl.umap(adata,color="PTPRC",vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121CD45.png")
```
<img src="..\figures\umap121CD45.png">
res0.2的cl0,1,5,9应该是非免疫细胞

### 上大类marker
```
marker_genes = {
"T":["CD3D","CD2","CD3E","CD3G"],
"B":["CD79A","MS4A1","CD22","CD19"],
"Fib": ["DCN","COL1A1","COL1A2","FN1","COL3A1","COL6A1"],
"Endo" : ["VWF","PECAM1","ENG","CDH5","CCL14"],
"Epi" : ["EPCAM","KRT8","KRT18","SFN","KRT5","KRT14",
         "CDH1","JUP","KRT13",
         "PPL","SPRR3"],
"Myeloid":["LYZ","CD14","GCA","HPGDS","CD68","IL3RA","LAMP3","CLEC4C","TPSAB1"]
}
marker_genes_in_data = {}
for ct, markers in marker_genes.items():
    markers_found = []
    for marker in markers:
        if marker in adata.var.index:
            markers_found.append(marker)
    marker_genes_in_data[ct] = markers_found
sc.pl.umap(adata,color=marker_genes_in_data["T"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121T.png")
sc.pl.umap(adata,color=marker_genes_in_data["B"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121B.png")
sc.pl.umap(adata,color=marker_genes_in_data["Fib"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Fib.png")
sc.pl.umap(adata,color=marker_genes_in_data["Endo"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo.png")
sc.pl.umap(adata,color=marker_genes_in_data["Epi"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Epi.png")
sc.pl.umap(adata,color=marker_genes_in_data["Myeloid"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Myeloid.png")
```
* T
<img src="..\figures\umap121T.png">
几个marker都还可以,可以就CD3E吧
* B
<img src="..\figures\umap121B.png">
CD79A特异性最好
* Fib
<img src="..\figures\umap121Fib.png">
几个marker都还可以,就COL1A1吧
* Endo
<img src="..\figures\umap121Endo.png">
VWF+PECAM1(这个不够特异但比较经典)
* Epi
<img src="..\figures\umap121Epi.png">
EPCAM+SFN+KRT5
* Myeloid
<img src="..\figures\umap121Myeloid.png">
LYZ,GCA,TPSAB1

### 用筛过一遍的marker绘图分群
```
marker_genes = ["PTPRC","CD3E","CD79A","COL1A1",
"VWF","PECAM1","EPCAM","SFN","KRT5","LYZ","GCA","TPSAB1"]
sc.pl.umap(adata,color=marker_genes,vmin=0,vmax="p99",sort_order=False,cmap="Blues",save="raw121_majorcluster.png")
```
<img src="..\figures\umapraw121_majorcluster.png">
髓系有一小块没有覆盖到,不过髓系就这样没有太好的大类marker

### 对比marker和聚类，去掉可能双细胞群
<img src="..\figures\121umaphvg4000_cluster.png">
res0_2看起来没有大的双细胞群,不过看起来是有一些亚群是上皮混了其它,在亚群阶段再去除吧

```
cl_annotation = {
    "0": "Epithelial cell",
    "1": "Epithelial cell",
    "2": "T&ILC cell",
    "3": "Myeloid cell",
    "4": "T&ILC cell",
    "5": "Fibrocyte",
    "6": "T&ILC cell",
    "7": "Myeloid cell",
    "8": "B cell",
    "9": "Endothelial cell",
    "10":"B cell",
    "11":"Myeloid cell",
}
adata.obs["major_celltype"]=adata.obs.leiden_res0_2.map(cl_annotation)



```
