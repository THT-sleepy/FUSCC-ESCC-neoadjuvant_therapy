# 内皮细胞注释过程及结果记录         (What)

* Nov 21, 2025                                 (When)
* liyi /data1/liyi/zhaoyue/FUSCC-ESCC-neoadjuvant_thrapy           (Where)
* 单细胞需要注释后才能进行后续分析 (Why)

#### 先看看聚类和celltypist注释情况
<img src="..\figures\umapEndothelial cell_umapmd0.4_regressmtribo_cluster.png">
<img src="..\figures\umap1121_celltypist__Endo.png">

#### 看下大类marker，是否有双细胞
```
import scanpy as sc

sc.settings.set_figure_params(
    dpi=300,
    facecolor="white",
    frameon=False
)
sc.settings.figdir = "plots"

adata = sc.read("RData/Endothelial cell__umapmd0.4.h5ad")

marker_genes = ["PTPRC","CD3E","CD79A","COL1A1",
"VWF","PECAM1","EPCAM","SFN","KRT5","LYZ","GCA","TPSAB1"]
sc.pl.umap(adata,color=marker_genes,vmin=0,vmax="p99",sort_order=False,cmap="Blues",save="121_Endo_majormarker.png")
```
<img src="..\figures\umap121_Endo_majormarker.png">
0.8第5群混了上皮细胞，去掉

```
adata = adata[adata.obs.leiden_res0_8 != '5'].copy()
```

#### 筛marker
```
marker_genes = {
    "AEC": ["GJA5", "FBLN5", "GJA4", "ENPP2", "SULF1"],
    "capEC": ["CA4", "CD36", "RGCC", "CD320", "SGK1", "SPP1", "GSN", "PLVAP"],
    "LEC": ["PROX1", "LYVE1", "CCL21", "TFPI", "PDPN", "TFF3"],
    "VEC": ["ACKR1", "SELP", "CLU", "CCL14", "CPE", "C7", "POSTN"],
    "TipEC": ["COL4A1", "KDR", "ESM1", "CXCR4", "TP53I11", "PGF", "ESM1"],
    "HypoxiaEC": ["MT1X", "MT1E", "MT2A"],
    "prfEC": ["PTTG1", "TYMS", "MKI67", "TOP2A", "CENPF"]
}
marker_genes_in_data = {}
for ct, markers in marker_genes.items():
    markers_found = []
    for marker in markers:
        if marker in adata.var.index:
            markers_found.append(marker)
    marker_genes_in_data[ct] = markers_found
sc.pl.umap(adata,color=marker_genes_in_data["AEC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo_AECmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["capEC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo_capECmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["LEC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo_LECmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["VEC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo_VECmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["TipEC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo_TipECmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["HypoxiaEC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo_HypoxiaECmarkers.png")
sc.pl.umap(adata,color=marker_genes_in_data["prfEC"],vmin=0,vmax="p99",sort_order=False,cmap="Reds",save="121Endo_prfECmarkers.png")
```
<img src="..\figures\umapEndothelial cell_umapmd0.4_regressmtribo_cluster.png">
0.8的第3群,"GJA4","GJA5","FBLN5","SULF1"
<img src="..\figures\umap121Endo_AECmarkers.png">
第1,2,6群,"RGCC"
<img src="..\figures\umap121Endo_capECmarkers.png">
0.8的第7群,"PROX1","CCL21", "TFPI", "PDPN", "TFF3"
<img src="..\figures\umap121Endo_LECmarkers.png">
0.8的0和4群？"ACKR1","CLU"
<img src="..\figures\umap121Endo_VECmarkers.png">
第2群?不太明确
<img src="..\figures\umap121Endo_TipECmarkers.png">
没有这一群
<img src="..\figures\umap121Endo_HypoxiaECmarkers.png">
倒是有这一群，res2的第15群
<img src="..\figures\umap121Endo_prfECmarkers.png">

#### 先看一波DEG
```
sc.tl.rank_genes_groups(
 adata, groupby="leiden_res0_8", method="wilcoxon", key_added="dea_leiden_res0_8"
)
sc.tl.filter_rank_genes_groups(
  adata,
  min_in_group_fraction=0.2,
  max_out_group_fraction=0.2,
  key="dea_leiden_res0_8",
  key_added="dea_leiden_res0_8_filtered",
 )
sc.pl.rank_genes_groups_dotplot(
  adata,
  groupby="leiden_res0_8",
  standard_scale="var",
  n_genes=10,
  key="dea_leiden_res0_8_filtered",
  save="regressmtribo_121_res0_8_Endo_top10gene.png"
)
```
<img src="..\figures\dotplot_regressmtribo_121_res0_8_Endo_top10gene.png">

#### 添加注释
0:VEC, "ACKR1","CLU","ITPKC","PDK4";ITPKC<br>;
4:VEC, "ACKR1","CLU";ACKR1<br>
1,2:capEC,"RGCC","SPRY4","EDIL3";RGCC<br>
6:EC,"CSF2RB","ZNF267";CSF2RB<br>
3:AEC,"GJA4","GJA5","FBLN5","SULF1";GJA4<br>
7:LEC,"PROX1","CCL21", "TFPI", "PDPN", "TFF3";PROX1<br>
15:prfEC,"PTTG1", "TYMS", "MKI67", "TOP2A", "CENPF";MKI67<br>
```
cl_annotation = {
        "0": "c37_VEC_IDPKC",
        "4": "c36_VEC_ACKR1",
        "1": "c40_capEC_RGCC",
        "2": "c40_capEC_RGCC",
        "6": "c41_EC_CSF2RB",
        "3": "c38_AEC_GJA4",
        "7": "c39_LEC_PROX1",
    }
adata.obs["minor_celltype"]=adata.obs.leiden_res0_8.map(cl_annotation)
adata.obs.loc[adata.obs['leiden_res2'] == '15', 'minor_celltype'] = 'c42_prfEC_MKI67'
adata.write("RData/EC_annotated.h5ad")
```

#### dotplot
```
marker_genes = [
"ACKR1","CLU",
"ITPKC","PDK4",
"GJA4","GJA5","FBLN5","SULF1",
"PROX1","CCL21", "TFPI", "PDPN", "TFF3",
"RGCC","SPRY4","EDIL3",
"CSF2RB","ZNF267",
"PTTG1", "TYMS", "MKI67", "TOP2A", "CENPF"]
from matplotlib.colors import LinearSegmentedColormap
custom_cmap = LinearSegmentedColormap.from_list("custom", ["#0A3D7C", "#F6F6F6", "#810426"])
dp = sc.pl.dotplot(
        adata,
        groupby="minor_celltype",
        categories_order = [
             "c36_VEC_ACKR1",
             "c37_VEC_IDPKC",
             "c38_AEC_GJA4",
             "c39_LEC_PROX1",
             "c40_capEC_RGCC",
             "c41_EC_CSF2RB",
             "c42_prfEC_MKI67",
        ],
        var_names=marker_genes,
        standard_scale="var",
        return_fig=True,
        var_group_labels="       ",
        var_group_positions =[(0,1),(2,3),(4,7),
        (8,12),(13,15),(16,17),(18,22)],
        cmap = custom_cmap
    )
dp.style(dot_edge_color='black', dot_edge_lw=1).savefig("plots/1122_dotplot_EC.png")
```
<img src="..\figures\1122_dotplot_EC.png">

#### 检查每个cluster患者数
```
adata.obs['Patient_ID'] = adata.obs['sample'].str.split('_').str[-1]
adata.obs.groupby('leiden_res0_8')['Patient_ID'].nunique()
```
<img src="..\figures\EC_亚群患者数.png">

#### umap sample_site
```
sc.settings.set_figure_params(
    dpi=300,
    facecolor="white",
    frameon=True
)
def determine_sample_site(group_name):
    # 检查 group_name 是否是字符串并且包含 'pbmc'
    if isinstance(group_name, str) and 'pbmc' in group_name.lower():
        return 'blood'
    else:
        return 'tumor'

# 使用 .apply() 将函数应用到 'sample_group' 列的每一个元素
adata.obs['sample_site'] = adata.obs['sample_group'].apply(determine_sample_site)
palette = {
     "blood":"#3A6FA1",
     "tumor":"#BA3931",
}
sc.pl.umap(adata,color="sample_site",palette=palette,save="EC_samplesite.png")
```

<img src="..\figures\umapEC_samplesite.png">

#### umap clt
```
palette = {
  "c36": "#5D7AB1",
  "c37": "#D2E9C7",
  "c38": "#9DD1C8",
  "c39": "#BCDD7A",
  "c40": "#EA8675",
  "c41": "#BCBBD7",
  "c42": "#9BBBD0",
}
cl_annotation = {
  "0": "c37",
  "4": "c36",
  "1": "c40",
  "2": "c40",
  "6": "c41",
  "3": "c38",
  "7": "c39",
    }
adata.obs["minor_clt"]=adata.obs.leiden_res0_8.map(cl_annotation)
adata.obs.loc[adata.obs['leiden_res2'] == '15', 'minor_clt'] = 'c42'

sc.pl.umap(adata,color="minor_clt",legend_loc="on data",title="Endothelial cells\n(n=20954)",palette=palette,save="1122_EC.png")
```
<img src="..\figures\umap1122_EC.png">
